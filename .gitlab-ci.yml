stages:
  - build
  - push
  - deploy

variables:
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_IMAGE: "cr.yandex/$YCR_REGISTRY_ID/$YCR_REPO/gateway"

default:
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin cr.yandex
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config

build-gateway:
  stage: build
  script:
    - docker build -t $DOCKER_IMAGE:$IMAGE_TAG -f HELM-CHARTS/piggymetrics-k8s/gateway/Dockerfile HELM-CHARTS/piggymetrics-k8s/gateway
    - docker tag $DOCKER_IMAGE:$IMAGE_TAG $DOCKER_IMAGE:latest

push-gateway:
  stage: push
  script:
    - docker push $DOCKER_IMAGE:$IMAGE_TAG
    - docker push $DOCKER_IMAGE:latest
  needs:
    - build-gateway
  tags:
    - my-gitlab-runner

deploy-gateway:
  stage: deploy
  script:
    - helm upgrade --install gateway ./HELM-CHARTS/helm3/gateway \
        --set image.repository=$DOCKER_IMAGE \
        --set image.tag=$IMAGE_TAG \
        --set image.pullPolicy=Always \
        --set service.port=8080 \
        --set ingress.enabled=true \
        --set ingress.hosts[0].host=gateway.spring-petclinic-project.ru \
        --set ingress.hosts[0].paths[0]=/
  only:
    - main
  environment:
    name: production
 